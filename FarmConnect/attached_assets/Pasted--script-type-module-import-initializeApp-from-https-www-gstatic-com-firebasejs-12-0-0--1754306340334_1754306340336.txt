<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-auth.js";
    import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDwCsIenLB6vNffeDU1gaMehNfy8PTHC1s",
      authDomain: "leaflearn-fublm.firebaseapp.com",
      projectId: "leaflearn-fublm",
      storageBucket: "leaflearn-fublm.firebasestorage.app",
      messagingSenderId: "1069384281099",
      appId: "1:1069384281099:web:47d75108f603e4b59e2b0e"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    const Cloud = {
      login: async (email, password) => {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        return { email: userCredential.user.email };
      },
      signup: async (email, password) => {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        return { email: userCredential.user.email };
      },
      saveUser: async (user) => {
        const uid = auth.currentUser.uid;
        await set(ref(db, 'users/' + uid), {
          email: user.email,
          name: user.name
        });
      }
    };

    let state = {
      user: null,
      mode: 'login',
      error: '',
      profileSaved: false
    };

    function render() {
      const main = document.getElementById('main');
      main.innerHTML = '';
      state.user ? renderDashboard(main) :
        state.mode === 'login' ? renderLogin(main) : renderSignup(main);
    }

    function renderLogin(parent){
      parent.innerHTML = `
        <h2>Sign In</h2>
        ${state.error ? `<div class="error">${state.error}</div>` : ''}
        <div class="form-group"><label>Email</label><input id="email" type="email"/></div>
        <div class="form-group"><label>Password</label><input id="password" type="password"/></div>
        <button class="btn" id="btnLogin">Login</button>
        <div class="toggle">No account? <a href="#" id="goSignup">Sign up</a></div>
      `;
      parent.querySelector('#goSignup').onclick = e => { e.preventDefault(); state.mode='signup'; state.error=''; render(); };
      parent.querySelector('#btnLogin').onclick = async () => {
        const email = parent.querySelector('#email').value.trim();
        const password = parent.querySelector('#password').value;
        try {
          state.user = await Cloud.login(email, password);
          state.error = ''; render();
        } catch (e) {
          state.error = e.message || 'Login failed'; render();
        }
      };
    }

    function renderSignup(parent){
      parent.innerHTML = `
        <h2>Create Account</h2>
        ${state.error ? `<div class="error">${state.error}</div>` : ''}
        <div class="form-group"><label>Email</label><input id="new-email" type="email"/></div>
        <div class="form-group"><label>Password</label><input id="new-password" type="password"/></div>
        <div class="form-group"><label>Confirm Password</label><input id="confirm-password" type="password"/></div>
        <button class="btn" id="btnSignup">Sign Up</button>
        <div class="toggle">Already have an account? <a href="#" id="goLogin">Login</a></div>
      `;
      parent.querySelector('#goLogin').onclick = e => { e.preventDefault(); state.mode='login'; state.error=''; render(); };
      parent.querySelector('#btnSignup').onclick = async () => {
        const email = parent.querySelector('#new-email').value.trim();
        const password = parent.querySelector('#new-password').value;
        const confirm = parent.querySelector('#confirm-password').value;
        if (password !== confirm) return state.error = 'Passwords do not match', render();
        try {
          state.user = await Cloud.signup(email, password);
          state.error = ''; render();
        } catch (e) {
          state.error = e.message || 'Sign up failed'; render();
        }
      };
    }

    function renderDashboard(parent){
      parent.innerHTML = `
        <h2>Dashboard</h2>
        <div class="form-group"><label>Your Name</label><input id="profile-name" value="${state.user.name || ''}" placeholder="Enter your name"/></div>
        <button class="btn" id="saveProfileBtn">Save Profile</button>
        <div class="success" id="saveMessage"></div>
        <button class="btn hidden" id="continueBtn">Continue</button>
        <div class="success"><a href="#" id="logout">Logout</a></div>
      `;

      parent.querySelector('#saveProfileBtn').onclick = async () => {
        state.user.name = parent.querySelector('#profile-name').value.trim();
        await Cloud.saveUser(state.user);
        document.getElementById('saveMessage').textContent = 'Profile saved!';
        state.profileSaved = true;
        document.getElementById('continueBtn').classList.remove('hidden');
      };

      parent.querySelector('#continueBtn').onclick = () => {
        window.location.href = 'HOME.PAGE.html';
      };

      parent.querySelector('#logout').onclick = e => {
        e.preventDefault();
        state.user = null;
        state.mode = 'login';
        state.profileSaved = false;
        render();
      };
    }

    render();
  </script>